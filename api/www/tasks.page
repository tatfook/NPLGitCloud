<?npl
API_ADDR = "https://api.nplgitcloud.com";
WEB_ADDR = "https://www.nplgitcloud.com";
GIST_ADDR = "https://gist.nplgitcloud.com";
DOCS_ADDR = "https://developer.nplgitcloud.com";

function get_pure_url(params)
    local url = request:url():match("^[^%?]*");
    for i = 1, #params do
        local value = request:get(params[i]);
        if (value) then
            if (not url:find("?")) then
                url = url .. "?" .. params[i] .. "=" .. tostring(value);
            else
                url = url .. "&" .. params[i] .. "=" .. tostring(value);
            end
        end
    end
    return url;
end

local function add_link(links, url, page, rel)
    if (link ~= "") then
        links = links .. ", ";
    end
    if (not url:find("?")) then
        links = links .. "<" .. url .. "?page=" .. tostring(page);
    else
        links = links .. "<" .. url .. "&page=" .. tostring(page);
    end
    local per_page = tonumber(request:get("per_page"));
    if (per_page) then
        links = links .. "&per_page=" .. per_page;
    end
    links = links .. '>; rel="' .. rel .. '"';
end

function process_pagination(url, count)
    local page = tonumber(request:get("page"));
    local per_page = tonumber(request:get("per_page"));
    if (not page) then
        page = 1;
    end
    if (not per_page) then
        per_page = 30;
    end
    local links = "";
    local last_page = math.floor((count - 1) / per_page) + 1;
    if (page ~= last_page) then
        add_link(links, url, page + 1, "next");
        add_link(links, url, last_page, "last");
    end
    if (page ~= 1) then
        add_link(links, url, page - 1, "prev");
        add_link(links, url, 1, "first");
    end
    return links;
end

function process_json_response(body, headers, status_code)
    if (headers) then
        for k, v in ipairs(headers) do
            response:set_header(k, v);
        end
    end
    if (status) then
        response:status(status_code);
    end
    response:send_json(body);
end

function process_failed_login()
    local body = {
        message = "Bad credentials",
        documentation_url = DOCS_ADDR
    };
    response:status(401):send_json(body);
end

function process_success_response()
    response:status(204):send();
end

function process_failed_rate_limit()
    local body;
    if (is_authenticated()) then
        body = {
            message = "API rate limit exceeded for " .. get_auth_user() .. ".",
            documentation_url = "https://developer.github.com/v3/#rate-limiting"
        };
    else
        body = {
            message = "API rate limit exceeded for " .. request:getpeername() .. ". (But here's the goog news: Authenticated requests get a higher rate limit. Check out the documentation for more details.)",
            documentation_url = "https://developer.github.com/v3/#rate-limiting"
        };
    end
    response:status(403):send_json(body);
end

function check_user_agent()
    if (not request:header("User-Agent")) then
        local body = "Request forbidden by administrative rules.\nPlease make sure your request has a User-Agent header.\nCheck https://developer.github.com for other possible causes.\n";
        response:status(403):send(body);
        return false;
    else
        return true;
    end
end
?>
